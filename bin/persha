#!/bin/sh

CMDPATH=$0
CMDNAME=$(basename "$CMDPATH")
pushd $(dirname "$CMDPATH") >/dev/null
while [ -h "$CMDNAME" ]; do
    CMDPATH=$(readlink "$CMDNAME")
	CMDNAME=$(basename "$CMDPATH")
    cd $(dirname "$CMDPATH")
done
SCRIPTPATH=$(pwd -P)
popd >/dev/null

if [ -z "$PERSHA_DATA" ]; then
	PERSHA_DATA=~/.persha
fi

mkdir -p "$PERSHA_DATA" >/dev/null
if [ ! -d "$PERSHA_DATA" ]; then
	echo "$PERSHA_DATA" is not a directory
	exit
fi

pushd "$PERSHA_DATA" >/dev/null
PERSHA_DATA=$(pwd -P)
popd >/dev/null

lockerror(){
	echo already running with PERSHA_DATA=$PERSHA_DATA
	exit 1
}

LOCKFILE="$PERSHA_DATA/lockfile"

if type flock >/dev/null 2>&1; then

	exec 9>"$LOCKFILE"
	flock -n 9 || lockerror

elif type shlock >/dev/null 2>&1; then

	shlock -p $$ -f "$LOCKFILE" || lockerror

fi

exec node ${SCRIPTPATH}/persha.js $*
